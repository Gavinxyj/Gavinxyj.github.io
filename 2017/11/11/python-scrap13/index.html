<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="版权声明:本文为作者原创文章，可以随意转载，但必须在明确位置标明出处！！！
tips：本基础系列旨在以爬虫带大家入门Python语言 
本章并不是要教你如何去打群架，本篇文章将主要介绍如何使用多线程来帮我们的提高程序的执行效率，「群架」只是为了更加生动的去描述多线程的现象，相信大部分读者都看过《叶问">
    

    <!--Author-->
    
        <meta name="author" content="Gavin">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="聚沙成塔--爬虫系列（十三）（如何正确的使用数据库三）"/>
    

    <!--Open Graph Description-->
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="Gavin Blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>聚沙成塔--爬虫系列（十三）（如何正确的使用数据库三） - Gavin Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Gavin Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/Gavinxyj">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>聚沙成塔--爬虫系列（十三）（如何正确的使用数据库三）</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        2017-11-11
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/爬虫系列/">#爬虫系列</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <blockquote>
<h3 id="版权声明-本文为作者原创文章，可以随意转载，但必须在明确位置标明出处！！！"><a href="#版权声明-本文为作者原创文章，可以随意转载，但必须在明确位置标明出处！！！" class="headerlink" title="版权声明:本文为作者原创文章，可以随意转载，但必须在明确位置标明出处！！！"></a>版权声明:本文为作者原创文章，可以随意转载，但必须在明确位置标明出处！！！</h3></blockquote>
<p><strong>tips</strong>：本基础系列旨在以爬虫带大家入门Python语言 </p>
<p>本章并不是要教你如何去打群架，本篇文章将主要介绍如何使用多线程来帮我们的提高程序的执行效率，「群架」只是为了更加生动的去描述多线程的现象，相信大部分读者都看过《叶问》，叶问为了在日本军那里拿到粮食它决定一次要打10个，这种模式就是单线程模式，他必须把10个人一个个打败了才能赢得粮食，这种模式也是我们前面章节用到的模式，虽然最终能够赢得胜利，但用时就比较长了。假设叶问有多只手，每次最多只能用两只手，那么他在和人对战的时候就可以出其不意的将对手干&gt; ### 版权声明:本文为作者原创文章，可以随意转载，但必须在明确位置标明出处！！！</p>
<p><strong>note</strong>：本基础系列旨在以爬虫带大家入门Python语言 </p>
<p>上一篇文章我们讲了如何使用Python语言操作sqlite、mysql数据库，当然前面讲到的都是一些简单的操作，复杂的数据库操作并不在本系列考虑的范围内，因为每一种数据库语言都可以单独的写一本书了，所以本系类旨在带大家入门，至于如何修行就要靠各位自己了。本篇的重点主要讲对象关系映射(Object Relational Mapping，简称ORM)</p>
<h3 id="什么是ORM"><a href="#什么是ORM" class="headerlink" title="什么是ORM"></a>什么是ORM</h3><p>对象-映射是ORM的核心思想，什么意思呢，就是它把前端的数据对象映射成关系数据库中的数据类型，所以有了ORM我们前端只需要使用一份代码，后端的数据库不论是sqlite、mysql、oracle等其它关系数据库只要改变连接字符串我们就能做到将前端的数据写到不同的关系数据库中，是不是很酷。</p>
<h3 id="安装SQLAlchemy"><a href="#安装SQLAlchemy" class="headerlink" title="安装SQLAlchemy"></a>安装SQLAlchemy</h3><p>目前比较流行的Python ORM库就是SQLAlchemy，它是第三方库，所以我们必须的先安装它采用使用它，可以到关网<a href="http://www.sqlalchemy.org/download.html" target="_blank" rel="external">http://www.sqlalchemy.org/download.html</a>下载，当然你也可以私信我，安装方式有两种，一种是源码安装，一种是使用pip安装，pip安装最简单在终端执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo pip install SQLAlchemy</div></pre></td></tr></table></figure></p>
<p>源码安装也很简单，将在官网下载的安装包加压，然后执行安装命令，曾哥过程如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tar -xvf SQLAlchemy-1.2.0b3.tar.gz</div><div class="line">cd SQLAlchemy-1.2.0b3</div><div class="line">sudo python setup.py install</div></pre></td></tr></table></figure></p>
<p>如何没有出现什么错误则则证明安装成功了，如果验证SQLAlchemy库安装好了这里就不在啰嗦了，前面的文章都有讲到</p>
<h3 id="SQLAlchemy的设计模型"><a href="#SQLAlchemy的设计模型" class="headerlink" title="SQLAlchemy的设计模型"></a>SQLAlchemy的设计模型</h3><p>SQLAlchemy有两种设计模型，两种设计模型可以组合起来用，也可以单独使用，不管是组合使用还是单独使用，它们最终调用的都是DPAPI，下图给出了两种设计模型的层次依赖图，SQLAlchemy ORM模型抽象的层次更高一些。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3485329-bb56df7da12f7ef6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="SQLAlchemy操作数据库流程"><a href="#SQLAlchemy操作数据库流程" class="headerlink" title="SQLAlchemy操作数据库流程"></a>SQLAlchemy操作数据库流程</h3><p>对于数据库操作流程我们要有一个核心的思想，就是「万变不离其中」，我们只需要知道操作数据库的本质流程是什么就可以了，操作数据库的本质流程是什么？ 首先我们要知道数据库是一个服务，它提供了数据库服务接口也就是DBAPI，所以无论第三方库是怎么设计的最终都需要调用数据库服务接口，那么数据库操作流程就分为以下几步：</p>
<ul>
<li><strong>第一步：</strong> 连接数据库，对于SQLAlchemy来说就是创建一个引擎<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line">engine = create_engine(<span class="string">'sqlite:///qiubai.db'</span>, convert_unicode=<span class="keyword">True</span>, echo=<span class="keyword">True</span>)</div></pre></td></tr></table></figure>
</li>
</ul>
<p>create_engine函数的第一个参数就是我们需要连接的数据库地址，这个数据库连接字符到那里去获取呢，两种途径，一种是到官网<a href="http://docs.sqlalchemy.org/en/latest/dialects/index.html" target="_blank" rel="external">http://docs.sqlalchemy.org/en/latest/dialects/index.html</a>这里去找数据库相应的连接字符串格式定义，另一种是在在你的Python安装目录里的lib目录里去找，windows目录如下，E:\Program Files\Python36\Lib\sqlalchemy\dialects，当然你的Python安装木块可能不在E盘，你可以看到这个目录下有sqlite、mysql、oracle等关系数据库，比如本章所用到的是sqlite，那么就双击sqlite这个目录，进入到目录后打个pysqlite.py这个文件，你会看到文件的开头部分就有connectstring格式：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3485329-fa95032a98645f1b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="连接字符串格式定义"></p>
<p>ubuntu在目录<strong>「/usr/local/lib/python3.5/dist-packages/SQLAlchemy-1.2.0b3-py3.5-linux-x86_64.egg/sqlalchemy/dialects」</strong>下。</p>
<ul>
<li><p><strong>第二步：</strong> 获取游标，在ORM里就是获得一个session（会话）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line">engine = create_engine(<span class="string">'sqlite:///qiubai.db'</span>, convert_unicode=<span class="keyword">True</span>, echo=<span class="keyword">True</span>)  </div><div class="line">db_session = sessionmaker(bind=engine, autocommit=<span class="keyword">False</span>, autoflush=<span class="keyword">False</span>)</div></pre></td></tr></table></figure>
</li>
<li><p><strong>第三步：</strong> 建立一个映射关系，文章的开头部分就说了ORM的核心思想就是关系映射， 所以我们要把一个对象映射成关系数据库表的字段，就像前一篇文章的CREATE TABLE语句一样，需要给表指定字段及类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</div><div class="line">Base = declarative_base()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Qiubai</span><span class="params">(Base)</span>:</span></div><div class="line">    __tablename__ = <span class="string">'qiubai'</span></div><div class="line">    id = Column(Integer, sqlite_autoincrement=<span class="keyword">True</span>, primary_key=<span class="keyword">True</span>)</div><div class="line">    userid = Column(String(<span class="number">20</span>), nullable=<span class="keyword">False</span>)</div><div class="line">    username = Column(String(<span class="number">20</span>), nullable=<span class="keyword">False</span>)</div><div class="line">    funny_num = Column(Integer, nullable=<span class="keyword">False</span>)</div><div class="line">    content = Column(String(<span class="number">1024</span>), nullable=<span class="keyword">True</span>)</div><div class="line">    url = Column(String(<span class="number">1024</span>), nullable=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, userid, username, funny_num, content, url)</span>:</span></div><div class="line">        self.userid = userid</div><div class="line">        self.username = username</div><div class="line">        self.funny_num = funny_num</div><div class="line">        self.content = content</div><div class="line">        self.url = url</div></pre></td></tr></table></figure>
</li>
<li><p><strong>第四步：</strong> 创建元素信息，映射关系定义好了，但是还没有映射到数据库里，所以最后异步就是将所有元素映射到数据库里</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line">engine = create_engine(<span class="string">'sqlite:///qiubai.db'</span>, convert_unicode=<span class="keyword">True</span>, echo=<span class="keyword">True</span>)  </div><div class="line">db_session = sessionmaker(bind=engine, autocommit=<span class="keyword">False</span>, autoflush=<span class="keyword">False</span>)</div><div class="line">Base.metadata.create_all(engine)</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">obj = Qiubai(<span class="string">'userid'</span>, <span class="string">'username'</span>, funny_num, <span class="string">'content'</span>, <span class="string">'url'</span>)</div><div class="line">session.add(obj)</div><div class="line">session.commit()</div></pre></td></tr></table></figure>
<h3 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#删除所有数据</span></div><div class="line">session.delete(obj)</div><div class="line">session.commit()</div><div class="line">delete</div><div class="line"><span class="comment">###删除指定数据</span></div><div class="line">session.query(obj).filter(obj.userid == <span class="string">'1234'</span>).delete()</div></pre></td></tr></table></figure>
<p>filter相当于where子句</p>
<h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查询所有数据</span></div><div class="line">session.query(Qiubai).all()</div><div class="line"><span class="comment"># 查询指定数据</span></div><div class="line">session.query(obj).filter(obj.userid == <span class="string">'1234'</span>).one()</div></pre></td></tr></table></figure>
<h3 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 更新所有数据</span></div><div class="line">session.query(Qiubai).update(&#123;Qiubai.funny_num:<span class="number">500</span>&#125;)</div><div class="line">session.commit()</div><div class="line"><span class="comment"># 更新指定数据</span></div><div class="line">session.query(Qiubai).filter(Qiubai.userid==<span class="string">'/users/33096359/'</span>).update(&#123;Qiubai.funny_num:<span class="number">500</span>&#125;)</div><div class="line">session.commit()</div></pre></td></tr></table></figure>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>在抓取糗百的项目的我又增加了两个文件，一个是TableDef.py文件，该文件主要负责关系映射，所有的表定义都放在这个文件，另一个文件是SqlalchemyImpl.py，该文件主要负责执行数据库操作，文件内容定义如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># TableDef.py</span></div><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, String, Integer</div><div class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</div><div class="line"></div><div class="line">Base = declarative_base()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Qiubai</span><span class="params">(Base)</span>:</span></div><div class="line">    __tablename__ = <span class="string">'qiubai'</span></div><div class="line">    id = Column(Integer, primary_key=<span class="keyword">True</span>)</div><div class="line">    userid = Column(String(<span class="number">20</span>), nullable=<span class="keyword">False</span>)</div><div class="line">    username = Column(String(<span class="number">20</span>), nullable=<span class="keyword">False</span>)</div><div class="line">    funny_num = Column(Integer, nullable=<span class="keyword">False</span>)</div><div class="line">    content = Column(String(<span class="number">1024</span>), nullable=<span class="keyword">True</span>)</div><div class="line">    url = Column(String(<span class="number">1024</span>), nullable=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, userid, username, funny_num, content, url)</span>:</span></div><div class="line">        self.userid = userid</div><div class="line">        self.username = username</div><div class="line">        self.funny_num = funny_num</div><div class="line">        self.content = content</div><div class="line">        self.url = url</div></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># SqlalchemyImpl.py</span></div><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</div><div class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, String, Integer</div><div class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</div><div class="line"><span class="keyword">from</span> TableDef <span class="keyword">import</span> Base, Qiubai</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlalchemyImpl</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""docstring for SqlalchemyImpl"""</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        engine = create_engine(<span class="string">'sqlite:///qiubai.db'</span>, convert_unicode=<span class="keyword">True</span>, echo=<span class="keyword">True</span>)      </div><div class="line">        self.db_session = sessionmaker(bind=engine, autocommit=<span class="keyword">False</span>, autoflush=<span class="keyword">False</span>)</div><div class="line">        <span class="comment"># Base.session = self.db_session</span></div><div class="line">        Base.metadata.create_all(engine)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert_record</span><span class="params">(self, items)</span>:</span></div><div class="line">        session = self.db_session()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> items:</div><div class="line">                obj = Qiubai(item[<span class="number">0</span>], item[<span class="number">1</span>], item[<span class="number">2</span>], item[<span class="number">3</span>], item[<span class="number">4</span>])</div><div class="line">                <span class="comment">#list_record.append(obj)</span></div><div class="line">                session.add(obj)</div><div class="line">            session.commit()</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            session.rollback()</div><div class="line">            <span class="keyword">raise</span> e</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_record</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            session = self.db_session()</div><div class="line">            session.delete(Qiubai)</div><div class="line">            session.commit()</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            <span class="keyword">raise</span> e</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dump_record</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            session = self.db_session()</div><div class="line">            ret = session.query(Qiubai).all()</div><div class="line">            print(ret)</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            <span class="keyword">raise</span> e</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update_reocrd</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            session = self.db_session()</div><div class="line">            session.query(Qiubai).filter(Qiubai.userid==<span class="string">'/users/33096359/'</span>).update(&#123;Qiubai.funny_num:<span class="number">500</span>&#125;)</div><div class="line">            session.commit()</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            <span class="keyword">raise</span> e</div></pre></td></tr></table></figure>
<p>值得主要的是在ORM创建字段映射的时候必须要有一个字段为primary_key， 也就是TableDef.py文件里id的定义</p>
<h3 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h3><p><img src="http://upload-images.jianshu.io/upload_images/3485329-d2e5ae2cbc93cb96.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="结果"><br>从终端打印出来的结果我们可以看到最终插入到数据库的结构语言依然是INSERT INTO TABLE…，所以ORM只是把数据类型和结构抽象出来了，如果你不想在终端看出这些输出信息，只需要将「engine = create_engine(‘sqlite:///qiubai.db’, convert_unicode=True, echo=True) 」语句中的echo赋值为false就可以了。</p>
<p>本篇文章到这里就结束了，本文并没有去验证mysql数据库，这个任务留给读者自己去验证，我将会把最终的代码放到我的git上，地址<a href="https://github.com/Gavinxyj/Python/tree/master/python_study/Scrapy/modules" target="_blank" rel="external">https://github.com/Gavinxyj/Python/tree/master/python_study/Scrapy/modules</a>欢迎大家fork、star。本文只讲了SQLAlchemy最基本的用法，更多的用法，想join, 关联查询都可以访问其官网文档<a href="http://docs.sqlalchemy.org/en/latest/" target="_blank" rel="external">http://docs.sqlalchemy.org/en/latest/</a>。</p>
<p><strong>note：</strong> 这里需要提醒大家的是，新学习一个东西的时候，不要一来就想着把它吃透，这样只会打消你的积极性，就像ORM一样我本人对它也用的不是很熟悉，只会一些简单的应用，那是因为我工作中用到它的地方不多，而且ORM有一定的限制性，没有你直接写SQL语言来的快和明了。ORM对于复杂的查询就有些力不从心了。所以学习一个东西我们一定要搞清楚侧重点，如果项目上一定要用到ORM那么我回过头来在深入去学习就是了。</p>
<hr>
<blockquote>
<p><strong>欢迎关注我的公众号:「爱做饭的老谢」，老谢一直在努力…</strong><br><img src="/img/hexobuild/weixin.jpg" alt=""></p>
</blockquote>
<p>上一篇：<a href="/2017/11/05/python-scrap12">聚沙成塔–爬虫系列（十二）（如何正确的使用数据库二）</a></p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                      
<section id="comment">  
  <!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="2017/11/11/python-scrap13/" data-title="聚沙成塔--爬虫系列（十三）（如何正确的使用数据库三）" data-url="http://gavinxyj.com/2017/11/11/python-scrap13/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"gavinxyj"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
</section>  
  
                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    
                        <li>
                            <a href="https://github.com/Gavinxyj" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://github.com/Gavinxyj" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://gavinxyj.com" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="mailto:xie_youjiang@163.com" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>